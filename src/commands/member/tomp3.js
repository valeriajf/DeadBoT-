/**
 * Converte v√≠deos para √°udio MP3
 * Extrai o √°udio de v√≠deos enviados com legenda
 *
 * @author Adaptado para DeadBoT
 */

const { PREFIX, TEMP_DIR } = require(`${BASE_DIR}/config`);
const { exec } = require("child_process");
const fs = require("fs");
const path = require("path");
const { InvalidParameterError, WarningError } = require(`${BASE_DIR}/errors`);
const { getRandomNumber, getContent } = require(`${BASE_DIR}/utils`);
const { downloadContentFromMessage } = require("baileys");

module.exports = {
  name: "tomp3",
  description: "Converte v√≠deos para √°udio MP3!",
  commands: ["tomp3", "video2mp3", "mp3"],
  usage: `${PREFIX}tomp3 (envie um v√≠deo com esta legenda)`,
  
  /**
   * @param {CommandHandleProps} props
   * @returns {Promise<void>}
   */
  handle: async ({
    isVideo,
    webMessage,
    sendWaitReact,
    sendSuccessReact,
    sendErrorReply,
    sendSuccessReply,
    sendAudioFromFile,
  }) => {
    try {
      if (!isVideo) {
        throw new InvalidParameterError(
          "‚ùå Voc√™ precisa enviar um v√≠deo com esta legenda!\n\n" +
          `*Como usar:*\n` +
          `üìπ Envie um v√≠deo\n` +
          `üìù Na legenda, coloque: ${PREFIX}tomp3\n\n` +
          `üí° *Dica:* O comando funciona apenas com v√≠deos enviados diretamente, n√£o com v√≠deos marcados.`
        );
      }

      await sendWaitReact();
      await sendSuccessReply("üéµ Convertendo v√≠deo para √°udio MP3...");

      const inputPath = await downloadVideoCustom(webMessage);

      if (!inputPath || !fs.existsSync(inputPath)) {
        throw new WarningError("‚ùå N√£o foi poss√≠vel baixar o v√≠deo. Tente novamente.");
      }

      const videoStats = fs.statSync(inputPath);
      const videoSizeMB = (videoStats.size / 1024 / 1024).toFixed(2);

      const outputPath = path.resolve(
        TEMP_DIR,
        `audio_${getRandomNumber(10_000, 99_999)}.mp3`
      );

      await convertVideoToMp3(inputPath, outputPath);

      if (!fs.existsSync(outputPath)) {
        throw new WarningError("‚ùå Falha na convers√£o do √°udio.");
      }

      const audioStats = fs.statSync(outputPath);
      const audioSizeMB = (audioStats.size / 1024 / 1024).toFixed(2);

      await sendSuccessReact();
      await sendAudioFromFile(outputPath);

      await sendSuccessReply(
        `‚úÖ *√Åudio extra√≠do com sucesso!*\n\n` +
        `üìä *Tamanho:* ${audioSizeMB} MB\n` +
        `üéµ *Formato:* MP3 192kbps\n` +
        `üíö *by DeadBoT*`
      );

      cleanupFile(inputPath);
      cleanupFile(outputPath);

    } catch (error) {
      if (error instanceof InvalidParameterError || error instanceof WarningError) {
        throw error;
      }
      
      await sendErrorReply(
        `‚ùå Erro ao converter o v√≠deo: ${error.message}\n\n` +
        `üí° Verifique se o FFmpeg est√° instalado no servidor.`
      );
    }
  },
};

/**
 * Baixa v√≠deo da mensagem usando getContent do DeadBoT
 * @param {Object} webMessage - Mensagem do WhatsApp
 * @returns {Promise<string>} Caminho do arquivo baixado
 */
async function downloadVideoCustom(webMessage) {
  const videoContent = getContent(webMessage, "video");
  
  if (!videoContent) {
    throw new WarningError(
      "‚ùå Erro ao processar o v√≠deo!\n\n" +
      `üí° *Solu√ß√£o:*\n` +
      `‚Ä¢ Certifique-se de enviar o v√≠deo COM a legenda ${PREFIX}tomp3\n` +
      `‚Ä¢ N√£o envie o comando separado do v√≠deo\n` +
      `‚Ä¢ O v√≠deo e o comando devem estar na mesma mensagem`
    );
  }

  const stream = await downloadContentFromMessage(videoContent, "video");

  let buffer = Buffer.from([]);
  for await (const chunk of stream) {
    buffer = Buffer.concat([buffer, chunk]);
  }

  if (buffer.length === 0) {
    throw new Error("Buffer de v√≠deo vazio");
  }

  const filePath = path.resolve(
    TEMP_DIR,
    `video_input_${getRandomNumber(10_000, 99_999)}.mp4`
  );

  fs.writeFileSync(filePath, buffer);
  
  return filePath;
}

/**
 * Converte v√≠deo para MP3 usando FFmpeg
 * @param {string} inputPath - Caminho do v√≠deo de entrada
 * @param {string} outputPath - Caminho do √°udio de sa√≠da
 * @returns {Promise<void>}
 */
function convertVideoToMp3(inputPath, outputPath) {
  return new Promise((resolve, reject) => {
    const ffmpegCommand = `ffmpeg -i "${inputPath}" -vn -acodec libmp3lame -ab 192k -ar 44100 -y "${outputPath}"`;

    exec(ffmpegCommand, { timeout: 60000 }, (error, stdout, stderr) => {
      if (error) {
        return reject(new Error("Falha ao converter o v√≠deo. Verifique se o FFmpeg est√° instalado."));
      }

      resolve();
    });
  });
}

/**
 * Remove arquivo de forma segura
 * @param {string} filePath - Caminho do arquivo
 */
function cleanupFile(filePath) {
  try {
    if (fs.existsSync(filePath)) {
      fs.unlinkSync(filePath);
    }
  } catch (error) {
    console.error(`Erro ao remover arquivo:`, error.message);
  }
}